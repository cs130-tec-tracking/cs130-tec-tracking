{% extends "base.html" %}
{% load activity_tags %}
{% load url from future %}

{% block title %}{{ block.super }} | Activities{% endblock %}

{% block content %}

{% for message in messages %}
<div class="ui-state-highlight ui-corner-all"><p><span class="ui-icon ui-icon-info"></span>{{ message }}</p></div>
{% endfor %}

{% for error in errors %}
<div class="ui-state-error ui-corner-all"><p><span class="ui-icon ui-icon-alert"></span>{{ error }}</p></div>
{% endfor %}

{% if perms.activites.can_accept_activity %}
<div class = "content_block">
<h2>Activities needing assignment</h2>
{% if unassigned_activities %}
<table>
    <thead>
        <tr>
		<th><span class="activity_head">TEC ID</span></th>
		<th><span class="activity_head">Event Type</span></th>
		<th><span class="activity_head">Event Title</span></th>
		<th><span class="activity_head">Organizer</span></th>
		<th><span class="activity_head">Start Date</span></th>
		<th><span class="activity_head">Actions</span></th>
        </tr>
    </thead>
    <tbody>
        {% for activity in unassigned_activities %}
            <tr>
                <td class="{% cycle 'row_one' 'row_two' %}"><a href="{% url 'activity_detail' activity.tec_id %}"><span class="ui-icon ui-icon-search"></span>{{ activity.tec_id }}</a></td>
                <td class="{% cycle 'row_one' 'row_two' %}">{{ activity.event_type }}</td>
                <td class="{% cycle 'row_one' 'row_two' %}">{{ activity.short_desc }}</td>
                <td class="{% cycle 'row_one' 'row_two' %}">{{ activity.event_organizer }}</td>
                <td class="{% cycle 'row_one' 'row_two' %}">{{ activity.event_start_date }}</td>
                <td class="{% cycle 'row_one' 'row_two' %}">
                  <a href="#"
                  onclick="show_assign_dialog('{{activity.tec_id }}',
                  '{{ activity.short_desc }}')"
                  class="actionlink">Assign</a>
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>There are no unassigned activities,</p>
{% endif %}
</div>
{% endif %}



{% if perms.activities.can_approve_activity %}
<div class="content_block">
<h2>Newly Assigned Activities</h2>
{% with accepted_activities=assignments|accepted %}
{% if accepted_activities %}
<table>
    <thead>
        <tr>
            <th>TEC ID</th><th>Priority</th><th>Event Type</th><th>Event Title</th><th>Start Date</th><th>Escalation Status</th><th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for assignment in accepted_activities %}
            <tr>
                <td><a href="{% url 'activity_detail' assignment.activity.tec_id %}"><span class="ui-icon ui-icon-search"></span>{{ assignment.activity.tec_id }}</a></td>
                <td>{{ assignment.priority }}</td>
                <td>{{ activity.event_type }}</td>
                <td>{{ activity.short_desc }}</td>
                <td>{{ activity.event_start_date }}</td>
                <td>{{ assignment.escalation_status }}</td>
                <td><a href="{% url 'activity_detail' assignment.activity.tec_id %}" class="actionlink">Accept</a></td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>You do not have any assigned activities.</p>
{% endif %}
{% endwith %}
</div>
{% endif %}



{% if user.is_authenticated %}
<div class="content_block">
<h2>Active Assigned Activities</h2>
{% with active_activities=assignments|incomplete %}
{% if active_activities %}
<table>
    <thead>
        <tr>
            <th>TEC ID</th><th>Priority</th><th>Event Type</th><th>Event Title</th><th>Start Date</th><th>Escalation Status</th>
        </tr>
    </thead>
    <tbody>
        {% for assignment in active_activities %}
            <tr>
                <td><a href="{% url 'activity_detail' assignment.activity.tec_id %}"><span class="ui-icon ui-icon-search"></span>{{ assignment.activity.tec_id }}</a></td>
                <td>{{ assignment.priority }}</td>
                <td>{{ activity.event_type }}</td>
                <td>{{ activity.short_desc }}</td>
                <td>{{ activity.event_start_date }}</td>
                <td>{{ assignment.escalation_status }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>You do not have any active activities.</p>
{% endif %}
{% endwith %}
</div>
{% endif %}


<div class="content_block">
<div id='calendar'></div>
</div>

<div id="assign_dialog">
  <form id="assign_form">
    <div style="clear: right;">
      <span id="assign_tec_id">TEC ID:</span>
      <br />
      <span id="assign_event_title">Event Title:</span>
    </div>
    <span>Assign to user: </span>
    <select id="assign_select">
      {% for user in users %}
        <option value="{{user.id}}">{{user.first_name}}
        {{user.last_name}}</option>
      {% endfor %}
    </select>
    <input type="submit" value="Assign" class="jsbutton" />
  </form>
</div>
{% endblock %}


{% block scripts %}
<script type='text/javascript'>
    function show_assign_dialog(id, title) {
        $("#assign_tec_id").text("TEC ID: " + id);
        $("#assign_event_title").text("Event Title: " + title);
        $("#assign_dialog").dialog("open");
    };

    $(document).ready(function() {
        $("#assign_dialog").dialog({autoOpen: false,
    title: 'Assign Activity', resizable: false});

        $('#calendar').fullCalendar({
            editable: false,
            events: [{% for activity in unassigned_activities %}
                {
                    id: '{{activity.tec_id}}',
                    title: '{{activity.short_desc}}',
                    start: new Date('{{activity.event_start_date}}'),
                    end: new Date('{{activity.event_end_date}}'),
                    url: "{% url 'activity_detail' activity.tec_id %}",
                },
            {% endfor %}
            ]
        });

    });
</script>
{% endblock %}
